\documentclass[aps,12pt]{revtex4}
\usepackage{graphicx}
\usepackage{amssymb,amsfonts,amsmath,amsthm}
\usepackage{chemarr}
\usepackage{bm}
\usepackage{pslatex}
\usepackage{mathptmx}
\usepackage{xfrac}
\usepackage{bookman}

%%  
\newcommand{\trn}[1]{{#1}^{\mathtt{T}}}
\newcommand{\conc}[1]{{\left[#1\right]}}
 
\begin{document}
\section{Species and Equilibria}
Let us consider an aqueous system with $M$ species $A_1,\ldots,A_M$.
Those $M$ species are involved in $N$ equilibria:
\begin{equation}
	\forall i\in[1:N], \; \sum_{j=1}^M \nu_{i,j} \conc{A_j} = 0,
	 \;\; K_i = \prod_{j=1}^M \conc{A_j}^{\nu_{ij}}
\end{equation}

\section{Chemical Topology and Extent}
We consider the chemical topology matrix:
\begin{equation}
	\bm{\nu} \in \mathcal{M}_{N,M}
\end{equation}
and a chemical extent:
\begin{equation}
	\vec{\xi} \in \mathbb{R}^{N}
\end{equation}
so that a set of concentrations $\vec{C}\in\mathbb{R}^M$ is described by:
\begin{equation}
	\vec{C} = \vec{C}_0 + \trn{\bm{\nu}} \vec{\xi}
\end{equation}


\section{Balancing active concentrations}

We define the active indicator of species $j$ in equilibrium $i$ by:

\begin{equation}
	 \bm{A}_{ij} = \delta_{\nu_{ij} \not= 0}
\end{equation}
Then we define the balance indicator for equilibrium $i$ by:
\begin{equation}
	 B_i(\vec{C}) = \sum_j  \bm{A}_{ij} \max(-C_j,0)
\end{equation}
and the global balance is reached when:
\begin{equation}
	\vec{ {B}} = \vec{0} = \bm{A} 
	\begin{pmatrix}
	\vdots\\
	\max(-C_j,0)\\
	\vdots
	\end{pmatrix}
\end{equation}
 
\begin{equation}
	\partial_{C_j} B_i = -\bm{A}_{ij} \mathcal{H}(-C_j)
\end{equation}
 
\begin{equation}
	\left<\partial_{\vec{C}} B_i\right| =
	\left<
 		\begin{array}{ccc}
	 	\cdots &  	 -\bm{A}_{ij} \mathcal{H}(-C_j) & \cdots\\
		\end{array}
	\right|
\end{equation}

\begin{equation}
	\left(\partial_{\vec{C}}\vec{B}\right)_{ij} =  - \bm{A}_{ij} \mathcal{H}(-C_j)
\end{equation}
 

 
\end{document}

Let us balance a set of invalid concentrations starting from $\vec{C}$.
We define the excess vector:
\begin{equation}
	\vec{X} = 
	\begin{pmatrix}
		\vdots\\
		\mathbb{A}_j \max(-C_j,0)\\
		\vdots\\
	\end{pmatrix}
\end{equation}
 so that we look for
\begin{equation}
	  \vec{C} + \left( \trn{\bm{\nu}} \left( \bm{\nu} \trn{\bm{\nu}}\right)^{-1} \bm{\nu}\right)   \vec{X}
\end{equation}



 \section{Regularising from Products and Reactants}

\subsection{Generic case}
We define an equilibrium condition:
\begin{equation}
	Q_i =  \underbrace{\left(K_i \prod_{j,\nu_{ij}<0} \conc{A_j}^{-\nu_{ij}}\right)}_{\text{reactants}} 
	- \underbrace{\left( \prod_{j,\nu_{ij}>0} \conc{A_j}^{\nu_{ij}}\right)}_{\text{products}}
	= \left(K_i \prod_{j} \conc{A_j}^{\nu^r_{ij}}\right)
	- \left( \prod_{j} \conc{A_j}^{\nu^p_{ij}}\right)  
\end{equation}
Then the acceptable set of concentrations are defined by
\begin{equation}
	\vec{Q}(\vec{C}) = \vec{0}
\end{equation}
Starting from $\vec{C}_0$, the equilibria will lead to
\begin{equation}
	\vec{Q}(\vec{C}_0+\trn{\bm{\nu}} \vec{\xi}) = \vec{0}
\end{equation}
We approximate
\begin{equation}
	\vec{0} \approx \vec{Q}_0 + \bm{J} \trn{\bm{\nu}} \vec{\xi}
\end{equation}
with
\begin{equation}
	\bm{J}_i = \partial_{\vec{C}} Q_i,\; \bm{J}_{ij}= \partial_{C_j} Q_i
\end{equation}

\begin{itemize}
\item $K_i$ is a concentration to the $\Delta_r \nu$.
\item $Q_i$ is a concentration to the $\Delta_r \nu_p$.
\item $J_{ij}$ is a concentration to the $\Delta_r \nu_p-1$.
\end{itemize}

\subsection{Single equilibrium}
In case of a singular but balanced system, one may try to solve one single equilibrium:
\begin{equation}
Q_i\left(\vec{C}_0 + \xi \vec{\nu}\right) = 0
\end{equation}
by simple bisection between the limiting extents.

\section{Booting  with Linear constraints}
Since we have $N\leq M$ equilibria, the chemical system is fully determined by
$N_c=M-N$ constraints.
We assume that these constraints are linear, defined with $\bm{R}\in\mathcal{M}_{N_c,M}$ and $\vec{\Lambda}\in\mathbb{R}^{N_c}$:
\begin{equation}
	\bm{R} \vec{C} = \vec{\Lambda}
\end{equation}
Let $\bm{S}\in\mathcal{M}_{N,M}$ orthogonal to $\bm{R}$, so that
\begin{equation}
	\vec{C} = \trn{\bm{R}} \vec{u} + \trn{\bm{S}} \vec{v}
\end{equation}
and
\begin{equation}
	\bm{R} \vec{C} = \left(\bm{R} \trn{\bm{R}}\right) \vec{u} = \vec{\Lambda}
\end{equation}
and
\begin{equation}
	\vec{C} = \underbrace{\trn{\bm{R}} \left(\bm{R} \trn{\bm{R}}\right)^{-1} \vec{\Lambda}}_{\vec{C}^\star} + \trn{\bm{S}} \vec{v}
\end{equation}
So we must solve:
\begin{equation}
	\vec{Q} \left( \vec{C}^\star + \trn{\bm{S}}\vec{v} \right) = \vec{0}
\end{equation}

\section{Damping}

We assume that $\vec{Q}\left({\vec{C}}\right)=\vec{0}$, and we add $\delta\vec{C}$ to the system. Then an extent $\vec{\xi}$
is produced to take the system back to equilibrium:
\begin{equation}
	\vec{Q}\left(\vec{C}+\delta\vec{C}+\trn{\bm{\nu}}\vec{\xi}\right)\simeq \vec{0}
\end{equation}
and:
\begin{equation}
	\bm{J}\delta\vec{C} + \left(\bm{J}\trn{\bm{\nu}}\right)\vec{\xi} \simeq -\vec{Q} \;\; (\simeq\vec{0})
\end{equation}
leading to:
\begin{equation}
	\vec{\xi} = -\left(\bm{J}\trn{\bm{\nu}}\right)^{-1} \left( \bm{J} \delta\vec{C} + \vec{Q} \right)
\end{equation}
and
\begin{equation}
	\delta'\vec{C} = \trn{\bm{\nu}} \left(\bm{J}\trn{\bm{\nu}}\right)^{-1} \bm{J} \delta\vec{C}
\end{equation}
\end{document}