\documentclass[aps,12pt]{revtex4}
\usepackage{graphicx}
\usepackage{amssymb,amsfonts,amsmath,amsthm}
\usepackage{chemarr}
\usepackage{bm}
\usepackage{pslatex}
\usepackage{mathptmx}
\usepackage{xfrac}
\usepackage{bookman}

%%  
\newcommand{\trn}[1]{{#1}^{\mathtt{T}}}
\newcommand{\conc}[1]{{\left[#1\right]}}
 
\begin{document}
\section{Species and Equilibria}
Let us consider an aqueous system with $M$ species $A_1,\ldots,A_M$.
Those $M$ species are involved in $N$ equilibria:
\begin{equation}
	\forall i\in[1:N], \; \sum_{j=1}^M \nu_{i,j} \conc{A_j} = 0,
	 \;\; K_i = \prod_{j=1}^M \conc{A_j}^{\nu_{ij}}
\end{equation}

\section{Chemical Topology and Extent}
We consider the chemical topology matrix:
\begin{equation}
	\bm{\nu} \in \mathcal{M}_{N,M}
\end{equation}
and a chemical extent:
\begin{equation}
	\vec{\xi} \in \mathbb{R}^{N}
\end{equation}
so that a set of concentrations $\vec{C}\in\mathbb{R}^M$ is described by:
\begin{equation}
	\vec{C} = \vec{C}_0 + \trn{\bm{\nu}} \vec{\xi}
\end{equation}


\section{Balancing active concentrations}
We define $\mathbb{A}_j=1$ for and active species, $\mathbb{A}_j=0$ otherwise.
Let us balance a set of invalid concentrations starting from $\vec{C}_0$.
We define the global excess:
\begin{equation}
	B\left(\vec{C}\right) = \sum_j \mathbb{A}_j \max(0,-C_j)
\end{equation}
so that
\begin{equation}
	\vec{\nabla}_{\vec{C}} B = 
	\begin{pmatrix}
		\vdots\\
		-\mathbb{A}_j \times (C_j<0) \\
		\vdots\\
	\end{pmatrix}
\end{equation}
We search for
\begin{equation}
	\vec{C} = \vec{C}_0 + \trn{\bm{\nu}} \vec{\xi}
\end{equation}
We got
\begin{equation}
	\vec{\nabla}_{\vec{\xi}} B = \bm{\nu} \vec{\nabla}_{\vec{C}} B
\end{equation}
and a descent direction:
\begin{equation}
	\vec{\delta}_b = \trn{\nu}\nu  
	\begin{pmatrix}
		\vdots\\
		\mathbb{A}_j \times (C_j<0) \\
		\vdots\\
	\end{pmatrix}
\end{equation}
which allows a search along
\begin{equation}
	\delta \vec{C} = %\left(\sqrt{\dfrac{\sum_j\left[\mathbb{A}_j \max(0,-C_j)\right]^2}{\vec{\delta}_b^2}}\right)
	\dfrac{B(\vec{C})}
	{\sqrt{\vec{\delta}_b^2}}
	 \vec{\delta}_b
\end{equation}

\section{Regularising from Products and Reactants}

\subsection{Generic case}
We define an equilibrium condition:
\begin{equation}
	Q_i =  \underbrace{\left(K_i \prod_{j,\nu_{ij}<0} \conc{A_j}^{-\nu_{ij}}\right)}_{\text{reactants}} 
	- \underbrace{\left( \prod_{j,\nu_{ij}>0} \conc{A_j}^{\nu_{ij}}\right)}_{\text{products}}
	= \left(K_i \prod_{j} \conc{A_j}^{\nu^r_{ij}}\right)
	- \left( \prod_{j} \conc{A_j}^{\nu^p_{ij}}\right)  
\end{equation}
Then the acceptable set of concentrations are defined by
\begin{equation}
	\vec{Q}(\vec{C}) = \vec{0}
\end{equation}
Starting from $\vec{C}_0$, the equilibria will lead to
\begin{equation}
	\vec{Q}(\vec{C}_0+\trn{\bm{\nu}} \vec{\xi}) = \vec{0}
\end{equation}
We approximate
\begin{equation}
	\vec{0} \approx \vec{Q}_0 + \bm{\Phi} \trn{\bm{\nu}} \vec{\xi}
\end{equation}
with
\begin{equation}
	\bm{\Phi}_i = \partial_{\vec{C}} Q_i,\; \bm{\Phi}_{ij}= \partial_{C_j} Q_i
\end{equation}

\begin{itemize}
\item $K_i$ is a concentration to the $\Delta_r \nu$.
\item $Q_i$ is a concentration to the $\Delta_r \nu_p$.
\item $J_{ij}$ is a concentration to the $\Delta_r \nu_p-1$.
\end{itemize}

\subsection{Single equilibrium}
In case of a singular but balanced system, one may try to solve one single equilibrium:
\begin{equation}
Q_i\left(\vec{C}_0 + \xi \vec{\nu}\right) = 0
\end{equation}
by simple bisection between the limiting extents.

\section{Booting Linear with Linear constraints}
Since we have $N\leq M$ equilibria, the chemical system is fully determined by
$P=M-N$ constraints.
We assume that these constraints are linear, defined with $\bm{P}\in\mathcal{M}_{P,M}$ and $\vec{\Lambda}\in\mathbb{R}^P$:
\begin{equation}
	\bm{P} \vec{C} = \vec{\Lambda}
\end{equation}
Let $\bm{Q}\in\mathcal{M}_{N,M}$ orthogonal to $\bm{P}$, so that
\begin{equation}
	\vec{C} = \trn{\bm{P}} \vec{u} + \trn{\bm{Q}} \vec{v}
\end{equation}
and
\begin{equation}
	\bm{P} \vec{C} = \left(\bm{P} \trn{\bm{P}}\right) \vec{u} = \vec{\Lambda}
\end{equation}
and
\begin{equation}
	\vec{C} = \trn{\bm{P}} \left(\bm{P} \trn{\bm{P}}\right)^{-1} \vec{\Lambda}+ \trn{\bm{Q}} \vec{v}
\end{equation}
\end{document}