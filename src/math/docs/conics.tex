\documentclass[aps]{revtex4}
\usepackage{graphicx}
\usepackage{amssymb,amsfonts,amsmath,amsthm}
\usepackage{chemarr}
\usepackage{bm}
\usepackage{pslatex}
\usepackage{mathptmx}
\usepackage{xfrac}
\usepackage{dejavu}

\newcommand{\mymat}[1]{\boldsymbol{#1}}
%\newcommand{\mytrn}[1]{{#1}^{\mathsf{T}}}
\newcommand{\mytrn}[1]{~^{\mathsf{t}}\!{#1}}
\newcommand{\myvec}[1]{\overrightarrow{#1}}
\newcommand{\mygrad}{\vec{\nabla}}
\newcommand{\myhess}{\mathcal{H}}


\begin{document}
\title{Fitting Conics}
\maketitle
\section{Settings}

We have a set of $N$ points $\vec{M}_i$ in a $\mathbb{R}^d$.
From the coordinates of those points, we form a set of vectors $\vec{Z}_i$,
so that a shape equation $\mathcal{S}$ may be written with the help of a set of parameters $\vec{A}$
such that:
\begin{equation}
\vec{M}_i\in\mathcal{S} \Leftrightarrow \vec{A}\cdot\vec{Z}_i = 0
\end{equation}
To fit the required variables among the parameters, we have to minimize:
\begin{equation}
 F^2 = \sum_{i=1}^N \left(\vec{A}\cdot\vec{Z}_i\right)^2
  = \mytrn{\vec{A}} \underbrace{\left(\sum_{i=1}^N\mytrn{\vec{Z}_i}\vec{Z}_i\right)}_{\mymat{S}} \vec{A}
\end{equation}
and we see that
\begin{equation}
	\mygrad_{\vec{A}} F^2 = 2 \mymat{S} \vec{A}
\end{equation}

\section{Direct Computation}
We assume that
\begin{equation}
	\vec{A} = \underbrace{\mytrn{\mymat{P}} \vec{U}}_{\text{parameters}} + \underbrace{\mytrn{\mymat{Q}} \vec{V}}_{\text{variables}}
\end{equation}
so that
\begin{equation}
 \vec{0} = \mygrad F^2 \Leftrightarrow \mymat{S}\left(\mytrn{\mymat{P}} \vec{U} + \mytrn{\mymat{Q}} \vec{V}\right) = \vec{0}
\end{equation}
and
\begin{equation}
	toto
\end{equation}

\end{document}

A generic conic equation is given by:
\begin{equation}
	a x^2 + b y^2 + c xy + d x + e y + f = \vec{A}\cdot\vec{Z} = 0
\end{equation}
with
\begin{equation}
	\vec{A} = \begin{bmatrix}
		a\\
		b\\
		c\\
		d\\
		e\\
		f\\
	\end{bmatrix}, \;\;
	\vec{Z} = \begin{bmatrix}
	x^2\\
	y^2\\
	xy\\
	x\\
	y\\
	1\\
	\end{bmatrix}
\end{equation}

To fit a conic equation to a set of points, we have to minimise:
\begin{equation}
	F(\vec{A}) = \sum_{i=1}^N \left( \vec{A}\cdot\vec{Z}_i\right)^2 =
	 \mytrn{\vec{A}} \underbrace{\left(\sum_{i=1}^N \vec{Z}_i\mytrn{\vec{Z}}_i\right)}_{\mymat{S}} \vec{A}
\end{equation}

For a univocal conic, we must also have a constraint matrix $\mymat{C}$ sur that
\begin{equation}
	\mytrn{\vec{A}}\mymat{C}\vec{A} = 1 
\end{equation}
So that we need to minimise the Lagrangian:
\begin{equation}
	\mathcal{L}(\vec{A},\lambda) = F(\vec{A}) - \lambda \left( \mytrn{\vec{A}}\mymat{C}\vec{A} - 1\right) 
\end{equation}
	
\begin{equation}
\begin{array}{rcl}
	\vec{0} = \partial \mathcal{L} & \Leftrightarrow & \vec{0} = \mymat{S}\vec{A} - \lambda \mymat{C}\vec{A}\\
	 & \Leftrightarrow & \mymat{S}^{-1}\mymat{C} \vec{A} = \dfrac{1}{\lambda} \vec{A}\\
\end{array}
\end{equation}


\end{document}

\section{Linear Constraints}
\subsection{Generic Case}
We assume that the degrees of freedom are reduced by $N_c$ linearly independent constraints  so that
\begin{equation}
	\mymat{P} \vec{A} = \vec{L},\;\;\mymat{P}\in\mathcal{M}_{N_c,6}, \;\; \vec{L} \in \mathbb{R}^{N_c}
\end{equation}
Accordingly, there exist $\vec{U}\in\mathbb{R}^{N_c}$, $\vec{V}\in\mathbb{R}^{6-N_c}$, and $\mymat{Q}\in\mymat{P}^{\perp}$
\begin{equation}
	\vec{A} = \mytrn{\mymat{P}} \vec{U} + \mytrn{\mymat{Q}} \vec{V} = \vec{A}^\star  + \mytrn{\mymat{Q}} \vec{V} 
\end{equation}
with
\begin{equation}
	\vec{A}^\star = \mytrn{\mymat{P}} \left(\mymat{P} \mytrn{\mymat{P}} \right) ^{-1} \vec{L}
\end{equation}
and now:
\begin{equation}
	\frac{1}{2} \mygrad_{\vec{V}} F = \mymat{Q}\mymat{S} \vec{A}^\star +  \mymat{Q}\mymat{S}\mytrn{\mymat{Q}} \vec{V}
\end{equation}
so that
\begin{equation}
	\vec{V} = - \left(\mymat{Q}\mymat{S}\mytrn{\mymat{Q}}\right)^{-1} \mymat{Q}\mymat{S} \vec{A}^\star 
\end{equation}
then
\begin{equation}
	\vec{A} = \left[\mymat{I}_6 -  \mytrn{\mymat{Q}}\left(\mymat{Q}\mymat{S}\mytrn{\mymat{Q}}\right)^{-1} \mymat{Q}\mymat{S} \right] \vec{A}^\star
	= \left[\mymat{I}_6 -  \mytrn{\mymat{Q}}\left(\mymat{Q}\mymat{S}\mytrn{\mymat{Q}}\right)^{-1} \mymat{Q}\mymat{S} \right] \mytrn{\mymat{P}} \left(\mymat{P} \mytrn{\mymat{P}} \right) ^{-1} \vec{L}
\end{equation}
\subsection{Circle}
We want $a=1$, $b=1$ and $c=0$, so that we have
\begin{equation}
	\mymat{P} = 
	\begin{bmatrix}
	1 & 0 & 0 & 0 & 0 & 0\\
	0 & 1 & 0 & 0 & 0 & 0\\
	0 & 0 & 1 & 0 & 0 & 0\\
	\end{bmatrix},
	\;\;
	\vec{L} = 
	\begin{bmatrix}
	1\\
	1\\
	0\\
	\end{bmatrix}
\end{equation}


\end{document}
